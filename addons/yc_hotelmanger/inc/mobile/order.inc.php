<?php/* * To change this license header, choose License Headers in Project Properties. * To change this template file, choose Tools | Templates * and open the template in the editor. */global $_GPC;global $_W;$seearr = $this->seearr;if (!$this->is_weixin()) {    message('请在微信中打开');}$mid = $_GPC['mid'];$sintdate = $_GPC['sintdate'];$soutdate = $_GPC['soutdate'];$hotelid = $_GPC['hotelid'];$roomid = $_GPC['roomid'];//print_r($_GPC);$d_time = $soutdate - $sintdate;$jwam = $d_time / 86400;$hotel = pdo_fetch('SELECT * FROM ' . tablename($this->hotel) . 'WHERE  status = 1 and uniacid =' . $this->_weid . ' and id =' . $hotelid);if (!$hotel) {    message('该酒店不存在！', '', 'info');}$room = pdo_fetch('SELECT * FROM ' . tablename($this->room) . 'WHERE  status = 1 and uniacid =' . $this->_weid . ' and hotelid =' . $hotelid . ' and id =' . $roomid);if (!$room) {    message('该酒店房型不存在！', '', 'info');} load()->model("mc");     $uid= mc_openid2uid($this->openid);     if(!$uid){        $uid=$_W['fans']['uid'];    }       $userjf= pdo_fetch('SELECT uid,credit3 FROM ' . tablename($this->members) . ' WHERE uniacid = ' . $this->_weid . ' and uid= '.$uid);    $levelt=pdo_fetchall('SELECT levelname,ordercount,discount FROM ' . tablename($this->mlevel) . ' WHERE uniacid = ' . $this->_weid .' ORDER BY ordercount DESC');     $zk='';    foreach ($levelt as $key => $level) {        if($level['ordercount']>$userjf['credit3']){            continue;        }else{            $zk= $level['discount'];            break;        }    } $zk=$zk==0?1:$zk;//$momy = pdo_fetch('SELECT * FROM ' . tablename($this->momy) . 'WHERE  status = 1 and uniacid =' . $this->_weid . ' and hotelid =' . $hotelid . ' and roomid =' . $roomid . ' and id =' . $mid);$momy['cprice']= floatval($room['mprice']*$zk);//if (!$momy) {//    message('该酒店房型套餐不存在！', '', 'info');//}require_once IA_ROOT . "/addons/yc_hotelmanger/jssdk.php";$signPackage = getSignPackage($_W['uniacid'], array("appsecret" => $_W['account']['secret'], "appid" => $_W['account']['key']));$sql = 'SELECT sum(yu_legth) as total FROM ' . tablename($this->order) . ' WHERE uniacid = ' . $this->_weid . ' and hotelid =' . $hotelid . ' and roomid =' . $roomid . ' and order_status < 4 and sintdate <=' . $sintdate . ' and soutdate >=' . $soutdate;$ycoune = pdo_fetchcolumn($sql);$momy['jcprice'] = floatval($room['mprice'] * $jwam);$sjy = $room['score'] - $ycoune;$result = mc_fetch($_W['member']['uid'], array('realname', 'mobile'));include $this->template('order');
<?php/* * To change this license header, choose License Headers in Project Properties. * To change this template file, choose Tools | Templates * and open the template in the editor. */global $_GPC;global $_W; load()->model("mc");     $uid= mc_openid2uid($this->openid);     if(!$uid){        $uid=$_W['fans']['uid'];    }       $userjf= pdo_fetch('SELECT uid,credit3 FROM ' . tablename($this->members) . ' WHERE uniacid = ' . $this->_weid . ' and uid= '.$uid);    $levelt=pdo_fetchall('SELECT levelname,ordercount,discount FROM ' . tablename($this->mlevel) . ' WHERE uniacid = ' . $this->_weid .' ORDER BY ordercount DESC');     $zk='';    foreach ($levelt as $key => $level) {        if($level['ordercount']>$userjf['credit3']){            continue;        }else{            $zk= $level['discount'];            break;        }    } $zk=$zk==0?1:$zk;if (!$this->is_weixin()) {    message('请在微信中打开');}$seearr = $this->seearr;$data = array('uniacid' => $this->_weid, 'order_on' => $this->build_order_no(), 'openid' => $this->openid, 'goods_name' => $_GPC['goods_name'], 'hotelid' => intval($_GPC['hotelid']), 'roomid' => intval($_GPC['roomid']), 'mid' => intval($_GPC['mid']), 'sintdate' => intval($_GPC['sintdate']), 'soutdate' => intval($_GPC['soutdate']), 'xtime' => $_GPC['xtime'], 'order_name' => $_GPC['name'], 'phone' => $_GPC['tel'], 'yu_legth' => $_GPC['lgth'], 'totalcpice' => $_GPC['zpice'], 'mode' => $_GPC['mode']);if ($data['mode'] == 'delivery') {    $data['order_status'] = 2;}$csql = 'SELECT * FROM ' . tablename($this->order) . ' WHERE uniacid = :uniacid AND openid =:openid AND goods_name = :goods_name AND hotelid = :hotelid AND roomid = :roomid ' . "\r\n" . '                    AND mid =:mid AND sintdate  = :sintdate AND soutdate=:soutdate AND  xtime = :xtime AND order_name=:order_name  AND phone =:phone AND yu_legth =:yu_legth AND totalcpice =:totalcpice AND mode = :mode';$result = pdo_fetch($csql, array(':uniacid' => $data['uniacid'], ':openid' => $data['openid'], ':goods_name' => $data['goods_name'], ':hotelid' => $data['hotelid'], ':roomid' => $data['roomid'], ':mid' => $data['mid'], ':sintdate' => $data['sintdate'], ':soutdate' => $data['soutdate'], ':xtime' => $data['xtime'], ':order_name' => $data['order_name'], ':phone' => $data['phone'], ':yu_legth' => $data['yu_legth'], ':totalcpice' => $data['totalcpice'], ':mode' => $data['mode']));if (!$result) {    $result = pdo_insert($this->order, $data);    $order_on = $data['order_on'];    $order_id = pdo_insertid();} else {    $order_on = $result['order_on'];    $order_id = $result['order_id'];} if ($result) {    $url = $this->createMobileUrl('Orderwx', array('order_on' => $order_on));    if ($data['mode'] == 'delivery') {        if ($seearr['istplnotice']) {            $this->get_sendorderok($seearr, $order_on);            $this->get_hotelordergl($seearr, $order_on);        }        message("酒店预定成功!", $this->createMobileUrl('orderinfo', array('order_id' => $order_id)), 'success');        return;    }    load()->model("activity");    $orderlist = pdo_fetch('SELECT * FROM ' . tablename($this->order) . 'WHERE  uniacid =' . $this->_weid . ' and openid =\'' . $this->openid . '\' and order_on =' . $order_on);    if (!$orderlist) {        message('订单支付链接错误，无法查找此订单!', '', 'error');    }    if ($list['order_status']) {        message('订单已付款!', '', 'error');    }    $fee = floatval($orderlist['totalcpice']);    if ($fee <= 0) {        message('支付错误, 金额小于0');    }    $params['tid'] = $orderlist['order_on'];    $params['user'] = $_W['fans']['from_user'];    $params['fee'] = $fee;    $params['title'] = $orderlist['goods_name'];    $params['ordersn'] = $orderlist['order_on'];    $params['virtual'] = true;    include $this->template('orderwx');    return;}message("订单提交失败!", '', "error");